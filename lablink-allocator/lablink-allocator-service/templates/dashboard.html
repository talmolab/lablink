<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <title>Terraform Output Dashboard</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css" rel="stylesheet">
    <style>
        .vm-status-card {
            transition: all 0.3s ease;
        }
        .status-indicator {
            width: 12px;
            height: 12px;
            border-radius: 50%;
            display: inline-block;
            margin-right: 8px;
        }
        .status-initializing {
            background-color: #ffc107;
            animation: pulse 2s infinite;
        }
        .status-running {
            background-color: #198754;
        }
        .status-error {
            background-color: #dc3545;
        }
        .status-unknown {
            background-color: #6c757d;
        }
        @keyframes pulse {
            0% { opacity: 1; }
            50% { opacity: 0.5; }
            100% { opacity: 1; }
        }
        .spinner-border-sm {
            width: 1rem;
            height: 1rem;
        }
        .vm-grid {
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(300px, 1fr));
            gap: 1rem;
        }
        .last-updated {
            font-size: 0.75rem;
            color: #6c757d;
        }
        .refresh-indicator {
            opacity: 0;
            transition: opacity 0.3s ease;
        }
        .refresh-indicator.show {
            opacity: 1;
        }
    </style>
</head>
<body class="bg-light">
    <div class="container mt-5">
        <h1 class="mb-4 text-center">Terraform Output Dashboard</h1>

        {% if output %}
        <!-- Terraform Output -->
        <details class="mb-3 border rounded shadow-sm p-3 bg-white">
            <summary class="fw-semibold text-success mb-2">Terraform Script Output</summary>
            <div class="alert alert-success mt-2">
                <h4 class="alert-heading">Terraform Script Ran Successfully!</h4>
                <pre class="mb-0">{{ output }}</pre>
            </div>
        </details>
        <!-- VM Status Section -->
        <div class="card mb-3">
            <div class="card-header d-flex justify-content-between align-items-center">
                <h5 class="mb-0">
                    <i class="bi bi-server me-2"></i>VM Status Monitor
                </h5>
                <div class="d-flex align-items-center">
                    <div class="refresh-indicator me-2" id="refresh-indicator">
                        <div class="spinner-border spinner-border-sm text-primary" role="status">
                            <span class="visually-hidden">Refreshing...</span>
                        </div>
                    </div>
                    <button class="btn btn-sm btn-outline-primary" onclick="toggleAutoRefresh()" id="auto-refresh-btn">
                        <i class="bi bi-arrow-clockwise me-1"></i>Auto Refresh: OFF
                    </button>
                    <button class="btn btn-sm btn-primary ms-2" onclick="refreshVMStatus()">
                        <i class="bi bi-arrow-clockwise me-1"></i>Refresh Now
                    </button>
                </div>
            </div>
            <div class="card-body">
                <div id="vm-status-container">
                    <div class="text-center text-muted py-4">
                        <div class="spinner-border" role="status">
                            <span class="visually-hidden">Loading VM status...</span>
                        </div>
                        <div class="mt-2">Loading VM status...</div>
                    </div>
                </div>
            </div>
        </div>
        {% elif credential_error %}
        <div class="alert alert-danger" role="alert">
            <h4 class="alert-heading">AWS Credentials Error</h4>
            <p>AWS credentials file not found. Please set AWS credentials first in the <a href="/admin">Admin Panel</a>.</p>
        </div>
        {% elif error %}
        <details class="mb-3 border rounded shadow-sm p-3 bg-white">
            <summary class="fw-semibold text-danger mb-2">Show Error</summary>
            <div class="alert alert-danger mt-2">
                <h4 class="alert-heading">Terraform Script Failed</h4>
                <pre class="mb-0">{{ error }}</pre>
            </div>
        </details>
        {% else %}
        <div class="alert alert-info" role="alert">
            No operation performed yet.
        </div>
        {% endif %}
        
        <div class="text-center mt-4">
            <a href="/admin" class="btn btn-secondary">Back to Admin</a>
        </div>
    </div>

    <script>
        let autoRefreshInterval;
        let isAutoRefreshing = false;
        let lastUpdateTime = null;

        function toggleAutoRefresh() {
            const btn = document.getElementById('auto-refresh-btn');
            
            if (isAutoRefreshing) {
                clearInterval(autoRefreshInterval);
                btn.innerHTML = '<i class="bi bi-arrow-clockwise me-1"></i>Auto Refresh: OFF';
                btn.className = 'btn btn-sm btn-outline-primary';
                isAutoRefreshing = false;
            } else {
                autoRefreshInterval = setInterval(refreshVMStatus, 5000); // Refresh every 5 seconds
                btn.innerHTML = '<i class="bi bi-pause me-1"></i>Auto Refresh: ON';
                btn.className = 'btn btn-sm btn-success';
                isAutoRefreshing = true;
                refreshVMStatus(); // Immediate refresh when enabled
            }
        }

        function showRefreshIndicator() {
            const indicator = document.getElementById('refresh-indicator');
            indicator.classList.add('show');
        }

        function hideRefreshIndicator() {
            const indicator = document.getElementById('refresh-indicator');
            indicator.classList.remove('show');
        }

        function refreshVMStatus() {
            showRefreshIndicator();
            
            fetch('/api/vm-status')
                .then(response => {
                    if (!response.status === 404) {
                        document.getElementById('vm-status-container').innerHTML = 
                            `<div class="alert alert-danger">
                                <i class="bi bi-exclamation-triangle me-2"></i>
                                VMs Starting Up... Please wait.
                            </div>`;
                    }
                    response.json()})
                .then(data => {
                    displayVMStatus(data);
                    lastUpdateTime = new Date();
                })
                .catch(error => {
                    console.error('Error fetching VM status:', error);
                    document.getElementById('vm-status-container').innerHTML = 
                        `<div class="alert alert-danger">
                            <i class="bi bi-exclamation-triangle me-2"></i>
                            Error loading VM status. Please try again.
                        </div>`;
                })
                .finally(() => {
                    setTimeout(hideRefreshIndicator, 500);
                });
        }

        function displayVMStatus(statusData) {
            const container = document.getElementById('vm-status-container');
            
            if (Object.keys(statusData).length === 0) {
                container.innerHTML = `
                    <div class="text-center text-muted py-4">
                        <i class="bi bi-server" style="font-size: 3rem; opacity: 0.3;"></i>
                        <div class="mt-2">No VMs found. VMs may still be starting up...</div>
                        <small class="text-muted">Status updates appear within 30-60 seconds of VM creation</small>
                    </div>`;
                return;
            }

            let html = '<div class="vm-grid">';
            
            for (const [hostname, status] of Object.entries(statusData)) {
                const statusInfo = getStatusInfo(status);
                
                html += `
                    <div class="vm-status-card card h-100">
                        <div class="card-body">
                            <div class="d-flex justify-content-between align-items-start">
                                <h6 class="card-title mb-0">
                                    <i class="bi bi-server me-2"></i>${hostname}
                                </h6>
                                <span class="badge ${statusInfo.badgeClass}">${statusInfo.displayText}</span>
                            </div>
                            
                            ${status === 'error' ? `
                                <div class="mt-2">
                                    <button class="btn btn-sm btn-outline-danger" onclick="showErrorDetails('${hostname}')">
                                        <i class="bi bi-exclamation-triangle me-1"></i>View Details
                                    </button>
                                </div>
                            ` : ''}
                        </div>
                    </div>
                `;
            }
            
            html += '</div>';
            
            const summary = getSummary(statusData);
            html = `
                <div class="row mb-3">
                    <div class="col-md-3">
                        <div class="text-center">
                            <div class="h4 text-success mb-0">${summary.running}</div>
                            <small class="text-muted">Running</small>
                        </div>
                    </div>
                    <div class="col-md-3">
                        <div class="text-center">
                            <div class="h4 text-warning mb-0">${summary.initializing}</div>
                            <small class="text-muted">Initializing</small>
                        </div>
                    </div>
                    <div class="col-md-3">
                        <div class="text-center">
                            <div class="h4 text-danger mb-0">${summary.error}</div>
                            <small class="text-muted">Errors</small>
                        </div>
                    </div>
                    <div class="col-md-3">
                        <div class="text-center">
                            <div class="h4 text-primary mb-0">${summary.total}</div>
                            <small class="text-muted">Total VMs</small>
                        </div>
                    </div>
                </div>
                <hr class="mb-3">
            ` + html;
            
            if (lastUpdateTime) {
                html += `<div class="text-center mt-3">
                    <small class="text-muted">
                        <i class="bi bi-arrow-clockwise me-1"></i>
                        Last updated: ${lastUpdateTime.toLocaleTimeString()}
                    </small>
                </div>`;
            }
            
            container.innerHTML = html;
        }

        function getStatusInfo(status) {
            switch(status) {
                case 'running':
                    return {
                        indicator: '<span class="status-indicator status-running"></span>',
                        displayText: 'RUNNING',
                        badgeClass: 'bg-success',
                        spinner: '<i class="bi bi-check-circle text-success"></i>'
                    };
                case 'initializing':
                    return {
                        indicator: '<span class="status-indicator status-initializing"></span>',
                        displayText: 'INITIALIZING',
                        badgeClass: 'bg-warning',
                        spinner: '<div class="spinner-border spinner-border-sm text-warning" role="status"></div>'
                    };
                case 'error':
                    return {
                        indicator: '<span class="status-indicator status-error"></span>',
                        displayText: 'ERROR',
                        badgeClass: 'bg-danger',
                        spinner: '<i class="bi bi-exclamation-circle text-danger"></i>'
                    };
                default:
                    return {
                        indicator: '<span class="status-indicator status-unknown"></span>',
                        displayText: 'UNKNOWN',
                        badgeClass: 'bg-secondary',
                        spinner: '<i class="bi bi-question-circle text-muted"></i>'
                    };
            }
        }

        function getSummary(statusData) {
            const summary = { running: 0, initializing: 0, error: 0, total: 0 };
            
            for (const [hostname, status] of Object.entries(statusData)) {
                summary.total++;
                switch(status) {
                    case 'running':
                        summary.running++;
                        break;
                    case 'initializing':
                        summary.initializing++;
                        break;
                    case 'error':
                        summary.error++;
                        break;
                }
            }
            
            return summary;
        }

        function showErrorDetails(hostname) {
            alert(`Error details for ${hostname} - check logs for more information`);
        }

        // Auto-start refresh if we have output (VMs were just created)
        {% if output %}
        document.addEventListener('DOMContentLoaded', function() {
            // Initial load after 10 seconds to allow VMs to start sending status
            setTimeout(() => {
                refreshVMStatus();
                // Auto-enable refresh for newly created VMs
                setTimeout(toggleAutoRefresh, 1000);
            }, 10000);
        });
        {% endif %}

        // Cleanup on page unload
        window.addEventListener('beforeunload', function() {
            if (autoRefreshInterval) {
                clearInterval(autoRefreshInterval);
            }
        });
    </script>
</body>
</html>
